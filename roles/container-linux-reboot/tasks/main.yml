---

- name: Force binaries directory for Container Linux by CoreOS
  set_fact:
    bin_dir: "/opt/bin"

- name: "Install Python if necessary (so we can be sure 'reboot' works)"
  raw: |
    #!/bin/bash
    set -e
    BINDIR="/opt/bin"
    mkdir -p $BINDIR
    cd $BINDIR
    if [[ -e $BINDIR/.bootstrapped ]]; then
      exit 0
    fi
    PYPY_VERSION=7.0.0
    wget -O - https://bitbucket.org/squeaky/portable-pypy/downloads/pypy3.5-$PYPY_VERSION-linux_x86_64-portable.tar.bz2 | tar -xjf -
    mv -n pypy3.5-$PYPY_VERSION-linux_x86_64-portable pypy3
    ln -s ./pypy3/bin/pypy3 python
    $BINDIR/python --version
    touch $BINDIR/.bootstrapped

- name: PXE boot into fresh Container Linux
  reboot: {}

- name: Install Python if necessary
  raw: |
    #!/bin/bash
    set -e
    BINDIR="/opt/bin"
    mkdir -p $BINDIR
    cd $BINDIR
    if [[ -e $BINDIR/.bootstrapped ]]; then
      exit 0
    fi
    PYPY_VERSION=7.0.0
    wget -O - https://bitbucket.org/squeaky/portable-pypy/downloads/pypy3.5-$PYPY_VERSION-linux_x86_64-portable.tar.bz2 | tar -xjf -
    mv -n pypy3.5-$PYPY_VERSION-linux_x86_64-portable pypy3
    ln -s ./pypy3/bin/pypy3 python
    $BINDIR/python --version
    touch $BINDIR/.bootstrapped

# https://github.com/rancher/k3s/issues/163#issuecomment-469882207
- name: Set hostname
  hostname:
    name: "{{ inventory_hostname }}"

- name: Add hostname to /etc/hosts
  lineinfile:
    dest: /etc/hosts
    regexp: '^127\.0\.0\.1[ \t]+localhost'
    line: '127.0.0.1 localhost {{ inventory_hostname }}'
    state: present

- name: Install pip
  become: yes
  raw: |
    #!/bin/bash
    set -e
    cd /opt
    curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py
    /opt/bin/python ./get-pip.py
    cp /opt/bin/pypy3/bin/pip /opt/bin/
    cp /opt/bin/pypy3/bin/pip3 /opt/bin/

- name: Install docker-py
  become: yes
  pip:
    name: docker
